/*
 JSONCache version 0.1.0

 Authors:
 Kimmo Puputti (first.last@futurice.com)
 Jarno Rantanen (first.last@futurice.com)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.

 Copyright (c) 2011 Kimmo Puputti
 Licenced under the MIT licence.
 See LICENCE file at https://github.com/kpuputti/JSONCache/
 for more information.
*/
(function(m){var g={version:"0.1.0",debug:!0,numTries:5,waitTime:200,itemLifetime:3E5,maxCacheSize:2621440,autoEvict:!0},c={};c.settings=g;var i=function(){if(g.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};g.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(d){a=!1}return b&&a}();var j=
function(b){var a=parseInt(window.localStorage["JSONCache size"],10),a=isNaN(a)?0:a,b=a+b*2;b<=0?window.localStorage.removeItem("JSONCache size"):window.localStorage["JSONCache size"]=b},n=function(b,a){var d=JSON.stringify(a),f=d.length,e=c._getTime(),h=function(){if(c.getCacheSize()+f*2>g.maxCacheSize&&(c.clean(),c.getCacheSize()+f*2>g.maxCacheSize))throw Error("Cache add would exceed maxCacheSize ("+(c.getCacheSize()+f*2)+" > "+g.maxCacheSize+")");try{window.localStorage["JSONCache data "+b]=d,
window.localStorage["JSONCache time "+b]=e,j(f)}catch(a){throw Error("Error adding data to localStorage, quota might be full.");}};if(g.autoEvict)for(;;)try{h();break}catch(k){if(c.getCacheSize()===0)throw Error("Cache add would exceed maxCacheSize ("+(c.getCacheSize()+f*2)+" > "+g.maxCacheSize+") even after autoEvicting everything");c.purgeOldest()}else h()};c.getCacheSize=function(){var b=parseInt(window.localStorage["JSONCache size"],10);return isNaN(b)?0:b};var l=function(b){b=parseInt(b,10);
return!isNaN(b)&&b+g.itemLifetime>=c._getTime()};c.clear=function(b){if(b)window.localStorage["JSONCache data "+b]&&j(-1*window.localStorage["JSONCache data "+b].length),window.localStorage.removeItem("JSONCache data "+b),window.localStorage.removeItem("JSONCache time "+b);else{var b=/^JSONCache (data|time) /,a,d,c=window.localStorage.length,e=[];for(a=0;a<c;++a)d=window.localStorage.key(a),b.test(d)&&e.push(d);c=e.length;for(a=0;a<c;++a)window.localStorage.removeItem(e[a]);window.localStorage.removeItem("JSONCache size")}};
c.clean=function(){var b=/^JSONCache time ([\S]+)$/,a,d,f=[],e,h=window.localStorage.length;for(e=0;e<h;++e)a=window.localStorage.key(e),(d=b.exec(a))&&!l(window.localStorage[a])&&f.push(d[1]);h=f.length;for(e=0;e<h;++e)c.clear(f[e])};c.purgeOldest=function(){for(var b=/^JSONCache time /,a,d=null,f,e,h=window.localStorage.length,g=0;g<h;++g)if(f=window.localStorage.key(g),b.test(f)&&(e=parseInt(window.localStorage[f],10),!isNaN(e)&&(d===null||e<d)))a=f,d=e;d!==null&&c.clear(a.replace("JSONCache time ",
""))};c._getJSONProxy=function(b,a){m.ajax(b,a)};c._getTime=function(){return(new Date).getTime()};c._tryGetJSON=function(b,a,d,f){if(d>g.numTries){if(i("Tried fetching",d-1,"times already, returning."),typeof a.ongiveup==="function")a.ongiveup("timeout")}else{a.error=function(e,g,k){i("Ajax error with status:",g);if(typeof a.onerror==="function")a.onerror(e,g,k,d);window.setTimeout(function(){c._tryGetJSON(b,a,d+1,f*2)},f)};if(typeof a.ontry==="function")a.ontry(d);c._getJSONProxy(b,a)}};c.getCachedJSON=
function(b,a){var a=a||{},d=a.success,f=window.localStorage["JSONCache data "+b],e=window.localStorage["JSONCache time "+b];f&&l(e)?(i("Value found from cache for url:",b),typeof d==="function"&&d(JSON.parse(f))):(i("Value not found in cache fetching data from url:",b),a.success=function(c){i("Fetched data, adding to cache for url:",b);try{n(b,c)}catch(e){if(typeof a.ongiveup==="function"){a.ongiveup("addfailure");return}}typeof d==="function"&&d(c)},a.dataType="json",c._tryGetJSON(b,a,1,g.waitTime))};
window.JSONCache=c})(jQuery);
